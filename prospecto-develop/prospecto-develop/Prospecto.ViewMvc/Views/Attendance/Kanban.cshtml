@model IEnumerable<Prospecto.Models.ViewModel.AttendanceViewModel>
@using Prospecto.Models.Enums
@{
    ViewData["Title"] = "Kanban de Atendimentos";
    var beginDate = ViewBag.BeginDate as DateTime?;
    var endDate = ViewBag.EndDate as DateTime?;
    var typeDate = ViewBag.TypeDate as int?;
}

<section class="content-header">
    <h1>@ViewData["Title"]</h1>
</section>

<div class="box box-primary">
    <div class="box-header with-border">
        <form method="get" asp-action="Kanban">
            <div class="row">
                <div class="col-md-2">
                    <div class="form-group">
                    <label>Data Inicial</label>
                    <input type="date" name="BeginDate" class="form-control" value="@ViewBag.BeginDate?.ToString("yyyy-MM-dd")" />
                </div>
                </div>

                <div class="col-md-2">
                    <div class="form-group">
                    <label>Data Final</label>
                    <input type="date" class="form-control" id="BeginDate" name="EndDate" value="@ViewBag.EndDate?.ToString("yyyy-MM-dd")" />
                </div></div>

                <div class="col-md-2">
                    <div class="form-group">
                    <label>Tipo de Data</label>
                    <select name="TypeDate" class="form-control">
                        @foreach (var item in (IEnumerable<SelectListItem>)ViewBag.ListTypeDate)
                        {
                            var selected = item.Selected ? "selected=\"selected\"" : "";
                            @:<option value="@item.Value" @Html.Raw(selected)>@item.Text</option>
                        }
                    </select>
                </div></div>

                <div class="col-md-3">
                    <div class="form-group">
                    <label>Status</label>
                    <select name="Status" class="form-control">
                        <option value="">Todos</option>
                        @foreach (var item in (IEnumerable<SelectListItem>)ViewBag.ListStatus)
                        {
                            var selected = item.Selected ? "selected=\"selected\"" : "";
                            @:<option value="@item.Value" @Html.Raw(selected)>@item.Text</option>
                        }
                    </select>
                </div> 
            </div>
                 <div class="row" style="margin-top:20px;">
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary"><i class="fa fa-search"></i> Filtrar</button>
                </div>
            </div>
           </div>

           
        </form>
    </div>

    <div class="box-body">
        <div class="row">
            @{
                var statusList = new[] {
                    StatusAttendancesEnum.OPEN,
                    StatusAttendancesEnum.RESCHEDULED,
                    StatusAttendancesEnum.CLOSED
                };
            }

            @foreach (var status in statusList)
            {
                <div class="col-md-4">
                    <div class="box box-solid" style="background-color: #f4f4f4;">
                        <div class="box-header with-border" style="background-color: #3c8dbc; color: white;">
                            <h3 class="box-title">@status.ToString()</h3>
                        </div>
                        <div class="box-body">
                            <div class="connectedSortable" data-status="@status.ToString()" style="min-height: 400px; border: 1px dashed #ccc; padding: 5px;">
                                @foreach (var item in Model.Where(x => x.Status == status))
                                {
                                    <div class="kanban-card" data-id="@item.Id" style="background: white; margin-bottom: 5px; padding: 10px; border-radius: 5px; box-shadow: 1px 1px 3px #aaa;">
                                        <strong>@item.NameClient</strong><br />
                                        <small>@item.Telephone</small><br />
                                        <small>Responsável: @item.User.Name</small><br />
                                        <small>Data Registro: @item.DateRegistred.ToString("dd/MM/yyyy")</small>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>


@section Scripts {
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <script>
        $(function () {
            $(".connectedSortable").sortable({
                connectWith: ".connectedSortable",
                placeholder: "ui-state-highlight",
                receive: function (event, ui) {
                    var itemId = ui.item.data("id");
                    var newStatus = $(this).data("status");

                    $.ajax({
                        type: "POST",
                        url: '@Url.Action("UpdateStatus", "Attendance")',
                        data: { id: itemId, status: newStatus },
                        success: function (response) {
                            if (response.success) {
                                toastr.success('Status atualizado com sucesso!');
                            } else {
                                toastr.error(response.message);
                            }
                        },
                        error: function () {
                            toastr.error('Erro ao atualizar o status.');
                        }
                    });
                }
            }).disableSelection();
        });
    </script>
}
